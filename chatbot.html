<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>melie - Assistente de Energia</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --header-bg: #005E54; /* Verde escuro para o header */
            --chat-bg: #EFEAE2; /* Fundo do chat similar ao WhatsApp */
            --user-bubble-bg: #E7FFDB; /* Verde claro para bal√£o do usu√°rio */
            --bot-bubble-bg: #FFFFFF; /* Bal√£o do bot */
            --text-primary: #111b21; /* Cor principal do texto */
            --text-secondary: #54656F; /* Cor secund√°ria do texto (timestamps) */
            --button-primary-bg: #008069; /* Verde para bot√µes prim√°rios */
            --button-primary-text: #FFFFFF;
            --input-area-bg: #F0F2F5;
            --border-color: #e9edef;
            --shadow-light: 0 1px 2px rgba(11, 20, 26, 0.08);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius-large: 12px;
            --border-radius-small: 8px;
            --animation-duration: 0.3s;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #dddbd1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            max-height: 90vh;
            background-color: var(--chat-bg);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .chat-header {
            background-color: var(--header-bg);
            color: var(--button-primary-text);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1em;
            font-weight: 500;
            flex-shrink: 0;
        }

        .chat-header .avatar {
            width: 40px;
            height: 40px;
            background-color: #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: var(--header-bg);
            font-size: 0.9em;
        }
        
        .chat-header .chat-info .name {
            font-weight: 500;
        }
        .chat-header .chat-info .status {
            font-size: 0.8em;
            opacity: 0.85;
        }

        .messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .messages::-webkit-scrollbar { width: 6px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb { background: #BFC0C0; border-radius: 3px; }
        .messages::-webkit-scrollbar-thumb:hover { background: #A0A0A0; }


        .message-wrapper {
            display: flex;
            max-width: 85%;
            animation: slideInUp var(--animation-duration) ease-out forwards;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-wrapper.user { align-self: flex-end; }
        .message-wrapper.bot { align-self: flex-start; }

        .message {
            padding: 8px 12px;
            border-radius: var(--border-radius-small);
            line-height: 1.45;
            font-size: 0.98em;
            box-shadow: var(--shadow-light);
            word-wrap: break-word;
        }
        
        .message.user {
            background-color: var(--user-bubble-bg);
            color: var(--text-primary);
        }

        .message.bot {
            background-color: var(--bot-bubble-bg);
            color: var(--text-primary);
        }
        
        .message.bot a {
            color: #00A884;
            text-decoration: underline;
            font-weight: 500;
        }

        .timestamp {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
            float: right;
            margin-left: 10px;
        }

        .options-container {
            padding: 8px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: var(--input-area-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .option-button {
            background-color: var(--bot-bubble-bg);
            color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            border-radius: var(--border-radius-small);
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
            font-size: 0.9em;
            font-weight: 500;
        }

        .option-button:hover {
            background-color: var(--header-bg);
            color: var(--button-primary-text);
            border-color: var(--header-bg);
            transform: scale(1.02);
        }

        .input-area {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--input-area-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .input-area input[type="text"] {
            flex-grow: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 24px;
            background-color: #ffffff;
            font-size: 0.95em;
            margin-right: 8px;
            outline: none;
            transition: box-shadow 0.2s;
        }

        .input-area input[type="text"]:focus {
             box-shadow: 0 0 0 2px var(--button-primary-bg);
        }

        .input-area button {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, transform 0.2s;
            font-size: 1.3em;
        }
        .input-area button:hover {
            background-color: #005E54;
            transform: rotate(15deg);
        }
        .send-icon { fill: white; width: 24px; height: 24px; }
        
        .typing-indicator .typing-dots { display: flex; align-items: center; padding: 5px 0; }
        .typing-indicator .typing-dots span {
            height: 8px; width: 8px;
            margin: 0 2px;
            background-color: #8E8E8E;
            border-radius: 50%;
            display: inline-block;
            animation: dot-pulse 1.4s infinite ease-in-out both;
        }
        .typing-indicator .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes dot-pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Cabe√ßalho do Chat -->
        <div class="chat-header">
            <div class="avatar">
                <!-- Certifique-se que o caminho para a imagem est√° correto -->
                <img src="images/avatar-whatsapp.png" alt="Avatar melie" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="chat-info">
                 <!-- Nome + Selo de Verificado -->
                <div style="display: flex; align-items: center;">
                    <div class="name" style="margin-right: 5px;">melie</div>
                    <svg style="width: 16px; height: 16px; color: #3498db;" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        <!-- √Årea de Mensagens -->
        <div class="messages" id="messages">
        </div>
        <!-- √Årea de Op√ß√µes -->
        <div class="options-container" id="optionsContainer">
        </div>
        <!-- √Årea de Input -->
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Digite uma mensagem...">
            <button onclick="handleSend()" aria-label="Enviar">
                <svg class="send-icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const optionsContainer = document.getElementById('optionsContainer');
        const userInput = document.getElementById('userInput');

        let currentState = 'NIVEL_0';
        let userName = '';
        let userPhone = '';
        let typingIndicator;

        function createTypingIndicator() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper bot typing-indicator';
            wrapper.style.display = 'none';
            wrapper.innerHTML = `<div class="message bot"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
            messagesDiv.appendChild(wrapper);
            typingIndicator = wrapper;
        }

        function showTypingIndicator(show) {
            if (typingIndicator) {
                typingIndicator.style.display = show ? 'flex' : 'none';
                if (show) messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        const melieScript = {
            NIVEL_0: {
                bot: [
                    "Ol√°! üëã Eu sou a melie, sua assistente virtual e marketplace de energia livre para baixa tens√£o! Cheguei para descomplicar o Mercado Livre de Energia para voc√™!",
                    "Minha miss√£o √© te mostrar os caminhos para economizar na conta de luz e ganhar mais liberdade de escolha. Prontinho(a) para come√ßar essa jornada?",
                    "Como posso te ajudar hoje?"
                ],
                options: [
                    { text: "O que √© esse tal de Mercado Livre de Energia? üí°", nextState: "OPCAO_1" },
                    { text: "melie, quais s√£o as vantagens e os pontos de aten√ß√£o? ‚öñÔ∏è", nextState: "OPCAO_2" },
                    { text: "Como eu economizo na conta de luz com isso, melie? üìâ", nextState: "OPCAO_3" },
                    { text: "melie, voc√™ pode dar uma olhada na minha conta pra ver se vale a pena? üì∏", nextState: "OPCAO_4_INICIO" },
                    { text: "Quero saber como fa√ßo pra mudar para o Mercado Livre! üöÄ", nextState: "OPCAO_5" },
                    { text: "Tem um dicion√°rio de termos do setor el√©trico, melie? üìñ", nextState: "OPCAO_7_INICIO" },
                    { text: "Prefiro falar com um especialista. üôã", nextState: "OPCAO_8_INICIO" }
                ]
            },
            OPCAO_1: {
                bot: [
                    "Claro! Deixa eu te explicar de um jeito bem simples: no Mercado Livre de Energia, √© como se voc√™ pudesse escolher o seu \"supermercado\" de energia el√©trica. Voc√™ negocia pre√ßos, prazos e at√© se quer energia de fontes renov√°veis, como solar ou e√≥lica. Bem diferente do mercado tradicional (o cativo), onde a gente s√≥ pode comprar da distribuidora da nossa regi√£o, n√©?",
                    "E a boa not√≠cia √© que essa liberdade agora est√° chegando para todo mundo, inclusive para resid√™ncias e pequenos com√©rcios como o seu!",
                    "Quer se aprofundar em algum detalhe ou prefere voltar ao menu?"
                ],
                options: [
                    { text: "Como funciona a negocia√ß√£o de pre√ßos?", nextState: "OPCAO_1_SUB_NEGOCIACAO" },
                    { text: "Quais s√£o as diferen√ßas para o mercado cativo?", nextState: "OPCAO_1_SUB_DIFERENCAS" },
                    { text: "Voltar ao menu principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }
                ]
            },
            OPCAO_1_SUB_NEGOCIACAO: { bot: ["A negocia√ß√£o de pre√ßos √© bem direta! Voc√™ conversa com as comercializadoras e busca fechar o melhor acordo, pensando no quanto voc√™ consome e por quanto tempo quer o contrato. √â como pechinchar, mas para a sua energia! üòä"], options: [{ text: "Entendi! Voltar.", nextState: "OPCAO_1"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_1_SUB_DIFERENCAS: { bot: ["No mercado cativo, √© tipo um pacote fechado: a ANEEL define os pre√ßos e voc√™ s√≥ tem a distribuidora local como op√ß√£o. J√° no Mercado Livre, voc√™ tem o poder de escolha! Negocia com diferentes fornecedores (geradores ou comercializadoras), buscando as melhores condi√ß√µes pra voc√™. Mais liberdade e chance de economizar!"], options: [{ text: "Saquei! Voltar.", nextState: "OPCAO_1"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_2: {
                bot: [
                    "Olha, mudar pro Mercado Livre pode ser uma √≥tima! As principais vantagens que o pessoal mais gosta s√£o:",
                    "‚úÖ <strong>Economia:</strong> Quem n√£o quer pagar menos na conta de luz, n√©? Negociando bem, o desconto pode ser bem interessante.",
                    "‚úÖ <strong>Liberdade de Escolha:</strong> Voc√™ no comando! Escolhe quem vai te fornecer energia e as condi√ß√µes.",
                    "‚úÖ <strong>Previsibilidade:</strong> Com contratos de pre√ßo fixo, voc√™ fica mais protegido(a) daquelas varia√ß√µes chatas na tarifa que √†s vezes assustam a gente.",
                    "‚úÖ <strong>Pegada Sustent√°vel:</strong> D√° pra escolher energia limpinha, de fontes renov√°veis como solar, e√≥lica... ajudando o planeta! üåé",
                    "Mas, como tudo na vida, √© bom ficar de olho em alguns pontos tamb√©m, t√°?",
                    "‚ö†Ô∏è <strong>Gest√£o do Contrato:</strong> Exige um pouquinho mais da sua aten√ß√£o para acompanhar o contrato de energia. Mas n√≥s da melie estamos aqui pra te dar suporte!",
                    "‚ö†Ô∏è <strong>Flutua√ß√µes do Mercado:</strong> Apesar da previsibilidade do seu contrato atual, o mercado de energia como um todo pode variar, o que pode influenciar futuras negocia√ß√µes quando seu contrato acabar.",
                    "‚ö†Ô∏è <strong>Escolher Bem o Fornecedor:</strong> √â super importante escolher uma comercializadora varejista que seja s√≥lida e de confian√ßa. N√≥s podemos te ajudar a encontrar as melhores op√ß√µes!",
                    "E a√≠, quer que eu detalhe algum desses pontos ou j√° quer fazer uma simula√ß√£o pra ver como seria no seu caso?"
                ],
                options: [
                    { text: "Sim, quero entender melhor a economia!", nextState: "OPCAO_3" },
                    { text: "Como escolho um fornecedor seguro, melie?", nextState: "OPCAO_2_SUB_FORNECEDOR" },
                    { text: "Como a previsibilidade me protege de aumentos?", nextState: "OPCAO_2_SUB_PREVISIBILIDADE" },
                    { text: "Voltar ao menu principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }
                ]
            },
            OPCAO_2_SUB_FORNECEDOR: { bot: ["Boa pergunta! Para escolher um fornecedor seguro, a dica √© pesquisar a reputa√ß√£o da comercializadora varejista e conferir se ela √© autorizada pela ANEEL. Vale tamb√©m dar uma olhada no tempo de mercado dela e, se poss√≠vel, buscar refer√™ncias de outros clientes. Transpar√™ncia e bom atendimento contam muito! Aqui na melie, j√° fazemos uma curadoria para te apresentar op√ß√µes confi√°veis."], options: [{ text: "Boas dicas, melie! Voltar.", nextState: "OPCAO_2"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_2_SUB_PREVISIBILIDADE: { bot: ["√â simples: no Mercado Livre, muitos contratos fixam o pre√ßo da sua energia por um per√≠odo determinado. Isso significa que, mesmo que as tarifas no mercado cativo subam por causa da chuva, do d√≥lar ou outras coisas, o seu pre√ßo combinado continua o mesmo at√© o fim do contrato. D√° uma paz de esp√≠rito, n√©?"], options: [{ text: "Faz sentido! Voltar.", nextState: "OPCAO_2"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_3: {
                bot: [
                    "A m√°gica da economia acontece principalmente porque voc√™ vai negociar o pre√ßo da energia (aquela parte da conta chamada \"Tarifa de Energia\" ou TE) direto com a comercializadora. No mercado cativo, esse pre√ßo √© definido pela ANEEL e j√° vem com um monte de outras coisinhas embutidas.",
                    "Al√©m disso, dependendo do seu jeito de consumir energia e do que voc√™ negociar, pode conseguir contratos bem mais camaradas! A economia varia de caso a caso, por isso uma simula√ß√£o √© legal.",
                    "Ah, um detalhe importante: a conta ainda vai ter a TUSD (Tarifa de Uso do Sistema de Distribui√ß√£o), que √© o que a gente paga pra distribuidora local usar os fios e postes pra energia chegar at√© voc√™. O que voc√™ negocia no Mercado Livre √© a energia em si (a TE), sacou? üòâ",
                    "Que tal a gente dar uma espiada na sua conta de luz pra ter uma ideia mais concreta?"
                ],
                options: [
                    { text: "Sim, melie, analisa minha conta! üì∏", nextState: "OPCAO_4_INICIO" },
                    { text: "Quais impostos t√™m na conta do Mercado Livre?", nextState: "OPCAO_3_SUB_IMPOSTOS" },
                    { text: "Qual a diferen√ßa entre TE e TUSD de novo?", nextState: "OPCAO_3_SUB_TE_TUSD" },
                    { text: "Voltar ao menu principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }
                ]
            },
            OPCAO_3_SUB_IMPOSTOS: { bot: ["Os impostos principais s√£o o ICMS (que varia de estado pra estado), PIS e COFINS. Eles tamb√©m est√£o na conta do mercado cativo, viu? A diferen√ßa pode estar na forma como s√£o calculados ou em alguma condi√ß√£o espec√≠fica do seu contrato no Mercado Livre, mas eles continuam l√°."], options: [{ text: "Entendido. Voltar.", nextState: "OPCAO_3"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_3_SUB_TE_TUSD: { bot: ["Vamos l√°: a <strong>TE (Tarifa de Energia)</strong> √© o pre√ßo da energia que voc√™ consome, tipo o 'produto' em si. √â essa parte que voc√™ negocia no Mercado Livre. J√° a <strong>TUSD (Tarifa de Uso do Sistema de Distribui√ß√£o)</strong> √© como um 'ped√°gio' que voc√™ paga pelo uso dos fios e postes da distribuidora pra energia chegar na sua casa ou com√©rcio. Essa parte continua sendo regulada e paga pra distribuidora local, mesmo no Mercado Livre."], options: [{ text: "Agora ficou claro, melie! Voltar.", nextState: "OPCAO_3"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_4_INICIO: {
                bot: ["Boa ideia! Para eu, a melie, conseguir te dar uma estimativa legal de economia, preciso que voc√™ me mande uma foto bem n√≠tida da sua √∫ltima conta de luz, t√°? Tenta pegar ela inteira, mostrando direitinho o consumo (em kWh), a tarifa e o valor total. \n\n(Como esta √© uma simula√ß√£o, apenas digite 'foto enviada' ou algo parecido no campo abaixo e pressione Enviar üòâ)"],
                inputExpected: true,
                nextStateAfterInput: "OPCAO_4_RECEBIDO"
            },
            OPCAO_4_RECEBIDO: {
                bot: [],
                onEnter: async (userInputText) => {
                    addBotMessage("Foto recebida! üëç S√≥ um minutinho enquanto eu dou uma processada aqui nas informa√ß√µes...");
                    showTypingIndicator(true);
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    showTypingIndicator(false);
                    const sucesso = Math.random() > 0.1; // 90% de chance de sucesso
                    if (sucesso) {
                        const consumoSimulado = Math.floor(Math.random() * 300) + 150;
                        const economiaSimulada = Math.floor(Math.random() * 15) + 5;
                        addBotMessage(`Prontinho! Analisei sua conta (simuladamente, claro!). Seu consumo foi de ${consumoSimulado} kWh no √∫ltimo m√™s. Com base nesse perfil e nas condi√ß√µes que temos hoje no Mercado Livre, a gente estima que voc√™ poderia ter uma economia de AT√â ${economiaSimulada}% se mudasse! E ainda teria mais previsibilidade nos seus gastos com energia, que tal?`);
                        handleStateChange("OPCAO_4_SUCESSO");
                    } else {
                        addBotMessage("Puxa... n√£o consegui ler todas as informa√ß√µes da sua conta (simulada). Ser√° que voc√™ poderia mandar uma 'nova foto' com melhor ilumina√ß√£o e foco, por favor?");
                        handleStateChange("OPCAO_4_FALHA");
                    }
                }
            },
            OPCAO_4_SUCESSO: {
                bot: ["E a√≠, curtiu a estimativa? Quer que um dos nossos especialistas aqui da melie entre em contato para detalhar essa simula√ß√£o e te explicar os pr√≥ximos passos, sem compromisso nenhum?"],
                options: [
                    { text: "Sim, quero falar com especialista! üôã", nextState: "OPCAO_8_INICIO" },
                    { text: "N√£o, obrigado. Quero tirar mais d√∫vidas.", nextState: "NIVEL_0" },
                    { text: "melie, como essa economia √© calculada?", nextState: "OPCAO_4_CALCULO_ECONOMIA" },
                    { text: "Gostaria de 'salvar' esta simula√ß√£o.", nextState: "OPCAO_4_SALVAR_SIMULACAO" }
                ]
            },
            OPCAO_4_FALHA: {
                bot: [],
                options: [
                    { text: "Tentar 'enviar' outra foto üì∏", nextState: "OPCAO_4_INICIO" },
                    { text: "Prefiro informar meu consumo m√©dio", nextState: "OPCAO_4_INFORMAR_CONSUMO_INPUT" },
                    { text: "Voltar ao menu principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }
                ]
            },
            OPCAO_4_INFORMAR_CONSUMO_INPUT: {
                bot: ["Sem problemas! Me diz a√≠, qual seu consumo m√©dio mensal em kWh? (S√≥ os n√∫meros, por favor)"],
                inputExpected: true,
                nextStateAfterInput: "OPCAO_4_CONSUMO_RECEBIDO"
            },
            OPCAO_4_CONSUMO_RECEBIDO: {
                onEnter: (userInputText) => {
                    const consumo = parseInt(userInputText);
                    if (isNaN(consumo) || consumo <= 0) {
                        addBotMessage("Hmm, esse valor n√£o parece um consumo v√°lido. Poderia me informar um n√∫mero positivo para o consumo em kWh, por favor?");
                        handleStateChange("OPCAO_4_INFORMAR_CONSUMO_INPUT");
                        return;
                    }
                    const economiaSimulada = Math.floor(Math.random() * 12) + 4;
                    addBotMessage(`Entendido! Com um consumo de ${consumo} kWh, a gente estima uma economia de AT√â ${economiaSimulada}% ao migrar para o Mercado Livre. Lembrando que essa √© s√≥ uma primeira ideia, t√°?`);
                    handleStateChange("OPCAO_4_SUCESSO");
                }
            },
            OPCAO_4_CALCULO_ECONOMIA: { bot: ["Basicamente, a gente compara o que voc√™ pagaria no mercado cativo (com as tarifas da distribuidora) com o que pagaria no Mercado Livre, onde o pre√ßo da energia (a TE) √© negociado. Mesmo pagando a TUSD (uso da rede) e os impostos, a economia na TE pode fazer uma bela diferen√ßa no final do m√™s!"], options: [{ text: "Entendi, melie!", nextState: "OPCAO_4_SUCESSO"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_4_SALVAR_SIMULACAO: { bot: ["Que legal que gostou! Para 'enviarmos' essa simula√ß√£o para voc√™ (lembre-se, √© s√≥ um faz de conta por enquanto üòâ), qual seu e-mail?"], inputExpected: true, nextStateAfterInput: "OPCAO_4_EMAIL_RECEBIDO" },
            OPCAO_4_EMAIL_RECEBIDO: {
                onEnter: (userInputText) => {
                    addBotMessage(`Perfeito! A simula√ß√£o (imagin√°ria, rs) foi "enviada" para ${userInputText}. Se tiver mais d√∫vidas, estou por aqui!`);
                    handleStateChange("NIVEL_0");
                }
            },
            OPCAO_5: {
                bot: [
                    "Opa, j√° querendo mais liberdade? Adorei! O caminho para o Mercado Livre de Energia tem alguns passos, mas relaxa que eu, a melie, te ajudo a entender cada um:",
                    "1. <strong>Conferir se voc√™ j√° pode:</strong> A gente precisa confirmar se seu perfil de consumo j√° se encaixa nas regrinhas pra baixa tens√£o.",
                    "2. <strong>Escolher sua Parceira de Energia:</strong> √â a chamada Comercializadora Varejista. Ela vai te representar no mercado e te fornecer a energia. N√≥s da melie te ajudamos com isso!",
                    "3. <strong>Simula√ß√£o e Proposta na M√£o:</strong> A comercializadora vai analisar seu consumo e te apresentar uma proposta.",
                    "4. <strong>Contrato Assinado, Futuro Tra√ßado:</strong> Hora de assinar o contrato de compra de energia.",
                    "5. <strong>Avisar a Distribuidora Atual:</strong> √â preciso notificar sua distribuidora de que voc√™ est√° de mudan√ßa para o Mercado Livre.",
                    "Parece um monte de coisa, n√©? Mas fica sussa, a comercializadora varejista que voc√™ escolher vai te dar toda a assessoria, e n√≥s da melie estamos aqui para facilitar!"
                ],
                options: [
                    { text: "Como escolher uma comercializadora?", nextState: "OPCAO_5_SUB_ESCOLHER_COMERCIALIZADORA" },
                    { text: "Quais documentos preciso ter?", nextState: "OPCAO_5_SUB_DOCUMENTOS" },
                    { text: "Quanto tempo leva tudo isso, melie?", nextState: "OPCAO_5_SUB_TEMPO" },
                    { text: "E se eu quiser voltar pro mercado cativo?", nextState: "OPCAO_5_SUB_VOLTAR_CATIVO" },
                    { text: "Voltar ao menu principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }
                ]
            },
            OPCAO_5_SUB_ESCOLHER_COMERCIALIZADORA: { bot: ["√â como escolher um bom parceiro! Pesquise a reputa√ß√£o da empresa, veja se ela √© autorizada pela ANEEL. Vale conferir o tempo de mercado, comparar as propostas com calma e, se puder, buscar opini√µes de outros clientes. Uma boa comercializadora √© transparente e te d√° suporte. A melie te ajuda a conectar com as melhores!"], options: [{ text: "Entendi, valeu melie!", nextState: "OPCAO_5"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_5_SUB_DOCUMENTOS: { bot: ["Geralmente, pedem seus documentos pessoais (RG, CPF) ou da sua empresa (CNPJ, contrato social), as contas de luz mais recentes pra ver seu consumo, e √†s vezes algum documento do im√≥vel. Mas cada comercializadora pode ter uma listinha um pouco diferente, elas te orientam direitinho!"], options: [{ text: "Ok, melie!", nextState: "OPCAO_5"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_5_SUB_TEMPO: { bot: ["Olha, o processo todo, desde a decis√£o at√© a energia come√ßar a chegar pelo Mercado Livre, pode levar de uns 90 a 180 dias. Depende um pouco da agilidade com os documentos e dos prazos da sua distribuidora atual. Mas a comercializadora te ajuda a n√£o perder nenhum prazo!"], options: [{ text: "Entendido!", nextState: "OPCAO_5"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_5_SUB_VOLTAR_CATIVO: { bot: ["Sim, pode voltar! Se por algum motivo voc√™ decidir que o Mercado Livre n√£o √© mais pra voc√™, existe um caminho para retornar ao mercado cativo. √â preciso avisar sua comercializadora e a sua distribuidora com uma certa anteced√™ncia. √â sempre bom checar as condi√ß√µes no seu contrato, pois pode haver prazos ou alguma condi√ß√£o espec√≠fica para essa volta, t√°?"], options: [{ text: "Bom saber! Voltar.", nextState: "OPCAO_5"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_7_INICIO: {
                bot: ["Com certeza! O mundo da energia tem uns terminos que parecem de outro planeta √†s vezes, n√©? üëΩ Mas eu te ajudo a decifrar! Sobre qual termo voc√™ quer saber mais? Pode digitar a√≠ ou escolher uma das op√ß√µes:"],
                options: [
                    { text: "'Comercializadora Varejista'", nextState: "OPCAO_7_TERMO_COMERCIALIZADORA" },
                    { text: "'Mercado Cativo' vs 'Mercado Livre'", nextState: "OPCAO_7_TERMO_MERCADOS" },
                    { text: "'Tarifa de Energia (TE)'", nextState: "OPCAO_7_TERMO_TE" },
                    { text: "'Tarifa de Uso do Sistema de Distribui√ß√£o (TUSD)'", nextState: "OPCAO_7_TERMO_TUSD" },
                    { text: "Quero digitar outro termo", nextState: "OPCAO_7_DIGITAR_TERMO" },
                    { text: "Voltar ao menu principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }
                ]
            },
            OPCAO_7_TERMO_COMERCIALIZADORA: { bot: ["<strong>Comercializadora Varejista:</strong> Pensa nela como uma empresa especializada que faz a ponte entre voc√™ e o Mercado Livre de Energia. Ela √© autorizada pela ANEEL. Ela compra energia no atacado e vende pra voc√™, consumidor de baixa tens√£o, te representando e cuidando de parte da burocracia. √â sua parceira nessa jornada!"], options: [{ text: "Entendi! Outros termos.", nextState: "OPCAO_7_INICIO"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_7_TERMO_MERCADOS: { bot: ["<strong>Mercado Cativo:</strong> √â o modelo tradicional, onde voc√™ s√≥ pode comprar energia da distribuidora da sua √°rea, com pre√ßos e regras definidos pela ANEEL. <br><strong>Mercado Livre:</strong> √â onde a m√°gica acontece! Aqui voc√™ tem liberdade para escolher seu fornecedor de energia, negociar pre√ßos, prazos e at√© o tipo de energia (como renov√°vel). √â mais poder de escolha e potencial de economia na sua m√£o!"], options: [{ text: "Clar√≠ssimo! Outros termos.", nextState: "OPCAO_7_INICIO"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_7_TERMO_TE: { bot: ["<strong>Tarifa de Energia (TE):</strong> √â basicamente o pre√ßo da energia el√©trica que voc√™ consome, medido em R$/kWh (reais por quilowatt-hora). No Mercado Livre, √© essa parte da sua conta que voc√™ vai negociar diretamente com a comercializadora."], options: [{ text: "Ok! Outros termos.", nextState: "OPCAO_7_INICIO"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_7_TERMO_TUSD: { bot: ["<strong>Tarifa de Uso do Sistema de Distribui√ß√£o (TUSD):</strong> Pensa nela como o 'aluguel' que voc√™ paga pelo uso dos fios, postes e toda a infraestrutura da distribuidora para a energia chegar at√© voc√™. Mesmo no Mercado Livre, voc√™ continua pagando a TUSD para a distribuidora local, pois ela ainda √© a dona dos 'caminhos' da energia."], options: [{ text: "Entendi! Outros termos.", nextState: "OPCAO_7_INICIO"}, { text: "Menu Principal ‚Ü©Ô∏è", nextState: "NIVEL_0" }] },
            OPCAO_7_DIGITAR_TERMO: {
                bot: ["Qual termo te deixou com uma pulga atr√°s da orelha? Pode digitar que eu tento explicar! üßê"],
                inputExpected: true,
                nextStateAfterInput: "OPCAO_7_EXPLICAR_TERMO_DIGITADO"
            },
            OPCAO_7_EXPLICAR_TERMO_DIGITADO: {
                onEnter: (userInputText) => {
                    const termo = userInputText.toLowerCase().trim();
                    let resposta = `Puxa, sobre "${userInputText}" eu ainda estou aprendendo os detalhes. Mas prometo pesquisar!`;
                    if (termo.includes("aneel")) {
                        resposta = "ANEEL √© a Ag√™ncia Nacional de Energia El√©trica. √â tipo o xerife do setor, sabe? Ela cria as regras e fiscaliza tudo pra garantir que a gente tenha energia com qualidade e seguran√ßa!";
                    } else if (termo.includes("kwh")) {
                        resposta = "kWh √© a sigla para quilowatt-hora. √â a unidade que a gente usa pra medir quanta energia voc√™ consumiu. Quanto mais kWh, maior o consumo!";
                    } else if (termo.includes("bandeira tarif√°ria") || termo.includes("bandeiras")) {
                        resposta = "Bandeiras Tarif√°rias s√£o aquelas cores (verde, amarela, vermelha) que aparecem na conta de luz do mercado cativo. Elas indicam se o custo pra gerar energia no pa√≠s est√° mais alto ou mais baixo. No Mercado Livre, como voc√™ negocia o pre√ßo da energia diretamente, voc√™ fica mais protegido dessas varia√ß√µes das bandeiras na parcela de energia (TE)!";
                    }
                    addBotMessage(resposta);
                    handleStateChange("OPCAO_7_INICIO");
                }
            },
            OPCAO_8_INICIO: {
                bot: ["Claro! Para um dos nossos especialistas aqui da melie te dar uma aten√ß√£o personalizada e tirar todas as suas d√∫vidas sobre o Mercado Livre de Energia, me conta seu nome completo, por favor?"],
                inputExpected: true,
                nextStateAfterInput: "OPCAO_8_PEDIR_TELEFONE"
            },
            OPCAO_8_PEDIR_TELEFONE: {
                onEnter: (userInputText) => {
                    userName = userInputText.trim();
                    if (!userName) {
                        addBotMessage("Por favor, me diga seu nome completo para continuarmos.");
                        handleStateChange("OPCAO_8_INICIO");
                        return;
                    }
                    addBotMessage(`Legal, ${userName}! Agora, pra facilitar o contato, qual seu telefone com DDD?`);
                    handleStateChange("OPCAO_8_PEDIR_TELEFONE_CONFIRM");
                }
            },
            OPCAO_8_PEDIR_TELEFONE_CONFIRM: {
                inputExpected: true,
                nextStateAfterInput: "OPCAO_8_CONFIRMACAO"
            },
            OPCAO_8_CONFIRMACAO: {
                onEnter: (userInputText) => {
                    userPhone = userInputText.trim();
                    if (!userPhone || !/^\(?\d{2}\)?\s?\d{4,5}-?\d{4}$/.test(userPhone)) {
                        addBotMessage(`Hmm, ${userName}, esse n√∫mero de telefone n√£o parece v√°lido. Poderia tentar de novo, incluindo o DDD? (Ex: (11) 98765-4321)`);
                        handleStateChange("OPCAO_8_PEDIR_TELEFONE_CONFIRM");
                        return;
                    }
                    addBotMessage(`Show, ${userName}! Anotei tudo aqui: seu telefone √© ${userPhone}. Um especialista da melie vai te ligar em breve, t√°? Nosso hor√°rio de atendimento para esse contato √© de segunda a sexta, das 9h √†s 18h.`);
                    handleStateChange("NIVEL_0");
                }
            },
            ERRO_NAO_ENTENDI: {
                bot: [],
                onEnter: () => {
                    addBotMessage(`Opa, ${userName ? userName + ", " : ""}essa eu n√£o peguei! üò¨ Que tal tentar de novo com outras palavras ou escolher uma das op√ß√µes que te mostrei no menu? Se for algum termo t√©cnico, a se√ß√£o "Dicion√°rio" pode ser uma boa!`);
                    handleStateChange("NIVEL_0");
                }
            },
            FINALIZAR_OBRIGADO: {
                bot: [],
                onEnter: () => {
                    addBotMessage(`De nada, ${userName || 'voc√™'}! Fico super feliz em ter ajudado. Se pintar mais alguma d√∫vida no futuro, √© s√≥ me chamar! A melie est√° aqui por voc√™. At√© mais! üëã`);
                    renderOptions([ { text: "Come√ßar uma nova conversa ‚ú®", nextState: "NIVEL_0" }]);
                }
            }
        };

        let currentBotStateData = {};

        function getCurrentTimestamp() {
            return new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function setCurrentStateData(stateData) {
            currentBotStateData = stateData;
        }

        function addMessageToScreen(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper', sender);

            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender);
            
            const textSpan = document.createElement('span');
            textSpan.innerHTML = text.replace(/\n/g, '<br>');
            
            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            timeSpan.textContent = getCurrentTimestamp();
            
            msgDiv.appendChild(textSpan);
            msgDiv.appendChild(timeSpan);
            messageWrapper.appendChild(msgDiv);
            
            if (typingIndicator && typingIndicator.parentNode === messagesDiv) {
                messagesDiv.insertBefore(messageWrapper, typingIndicator);
            } else {
                messagesDiv.appendChild(messageWrapper);
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addBotMessage(text) { addMessageToScreen(text, 'bot'); }
        function addUserMessage(text) { addMessageToScreen(text, 'user'); }

        function renderOptions(optionsArray) {
            optionsContainer.innerHTML = '';
            if (optionsArray && optionsArray.length > 0) {
                optionsArray.forEach(opt => {
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.innerHTML = opt.text;
                    button.onclick = () => handleOptionClick(opt.nextState, opt.text);
                    optionsContainer.appendChild(button);
                });
            }
        }
        
        async function handleStateChange(newStateKey, userTextForBot = null) {
            currentState = newStateKey;
            const stateData = melieScript[currentState];
            setCurrentStateData(stateData);

            if (!stateData) {
                console.error("Estado n√£o encontrado:", currentState);
                await handleStateChange("ERRO_NAO_ENTENDI");
                return;
            }

            userInput.value = '';
            
            if (!stateData.inputExpected) {
                optionsContainer.innerHTML = '';
            }
            
            const willBotSpeak = (stateData.bot && stateData.bot.length > 0) || (stateData.onEnter); 

            if (willBotSpeak) {
                showTypingIndicator(true);
                await new Promise(resolve => setTimeout(resolve, 600));
            }

            if (stateData.onEnter) {
                await stateData.onEnter(userTextForBot || userInput.value);
                if (currentState !== 'OPCAO_4_RECEBIDO') {
                    showTypingIndicator(false);
                }
            } else {
                if (stateData.bot) {
                    const botMessages = Array.isArray(stateData.bot) ? stateData.bot : [stateData.bot];
                    for (const msg of botMessages) {
                        if (msg) {
                            showTypingIndicator(false);
                            let personalizedMsg = msg.replace(/\[Nome do Usu√°rio\]/g, userName).replace(/\[Telefone do Usu√°rio\]/g, userPhone);
                            addBotMessage(personalizedMsg);
                            showTypingIndicator(true);
                            await new Promise(resolve => setTimeout(resolve, msg.length > 100 ? 1200 : 800));
                        }
                    }
                }
                showTypingIndicator(false);
                if(stateData.options) renderOptions(stateData.options);
            }

            if (stateData.inputExpected) {
                userInput.focus();
                optionsContainer.innerHTML = '';
            }
        }

        function handleOptionClick(nextStateKey, optionText) {
            addUserMessage(optionText);
            handleStateChange(nextStateKey);
        }

        function handleSend() {
            const text = userInput.value.trim();
            if (text === "") return;

            addUserMessage(text);
            
            const stateData = currentBotStateData;

            if (stateData && stateData.inputExpected && stateData.nextStateAfterInput) {
                handleStateChange(stateData.nextStateAfterInput, text);
            } else {
                let matchedOption = false;
                if (melieScript[currentState] && melieScript[currentState].options) {
                    for (const opt of melieScript[currentState].options) {
                        const optionWords = opt.text.toLowerCase().replace(/[^\w\s]/gi, '').split(" ").slice(0, 2).join(" ");
                        if (text.toLowerCase().includes(optionWords)) {
                            handleStateChange(opt.nextState);
                            matchedOption = true;
                            break;
                        }
                    }
                }
                if (!matchedOption) {
                    if (text.toLowerCase() === "menu" || text.toLowerCase() === "voltar") {
                        handleStateChange("NIVEL_0");
                    } else {
                        handleStateChange("ERRO_NAO_ENTENDI");
                    }
                }
            }
            userInput.value = '';
        }

        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleSend();
            }
        });

        window.onload = () => {
             createTypingIndicator();
             setTimeout(() => {
                 handleStateChange('NIVEL_0');
             }, 100);
        };
    </script>
</body>
</ht
